!function(t,e,s,i,c,a,l,n){"use strict";var o={isInitTemplate:!1,$mcycleCenter:e("#mcycleCenter"),$mcycleTopbarFlow:e("#mcycleTopbarFlow"),session:t.sessionStorage,sessionName:"__MZSTOREMCYCLE__",alert:new i({title:"提示",content:"网络错误",isAlert:!0}),template:{model:{model:'<div class="mcycle-model"/>',bread:['<ul class="mcycle-bread clearfix">','<li class="mcycle-bread-box reselect-phone"><a href="javascript:;">重选机型</a></li>','<li class="mcycle-bread-box reselect-description"><a href="javascript:;">重新评估</a></li>',"</ul>"].join(""),modelContentBox:function(t){var e=1==t?"":"finally";return'<div class="mcycle-model-content clearfix '+e+'" />'},modelImage:function(t){return'<div class="mcycle-model-img" style="background-image: url('+t+')"></div>'},modelMain:['<div class="mcycle-model-main">','<div class="mcycle-model-name" title="{{name}}">{{name}}</div>','<div class="mcycle-model-average">','<p class="mcycle-model-average-text">30天回购均价 <span class="mcycle-model-price">{{price}}</span></p>','<p class="mcycle-model-average-text">此价格不包含魅族补贴</p>','<p class="mcycle-model-average-tips"><i class="mcycle-font">&#xe60b;</i>请如实描述您的手机,以获最准确的报价。</p>',"</div>","</div>"].join(""),modelMainFinallyBox:'<div class="mcycle-model-finally" />',modelMainFinally:['<p class="mcycle-model-finally-text">最终预估价：<span class="mcycle-model-price">{{totalPrice}}</span></p>','<div class="mcycle-model-finally-box clearfix">','<div class="mcycle-model-finally-box-content">',"<p>回收企业估价</p>","<p>￥{{appraisal}}</p>","</div>",'<div class="mcycle-model-finally-box-content">',"<p>魅族额外补贴</p>","<p>￥{{aThrSubsidy}}</p>","</div>",'<div class="mcycle-model-finally-plus">','<div class="mcycle-model-finally-horizontal"></div>','<div class="mcycle-model-finally-vertical"></div>',"</div>","</div>",'<p class="mcycle-model-finally-tips">* 此价格为预估价格，以最终检测价格为准。</p>'].join(""),modelDescription:'<ul class="mcycle-model-description clearfix" />',modelDescriptionDetail:function(t){return'<li class="mcycle-model-desctiption-detail" title="'+t+'">'+t+"</li>"}},centerMain:'<div id="mcycleCenterMain" />',promise:['<div class="mcycle-promise">','<ul class="mcycle-promise-list clearfix">','<li class="mcycle-promise-model">','<div class="mcycle-promise-icon"><i class="mcycle-font icon-jiankong"></i></div>','<div class="mcycle-promise-title">全程视频监控</div>','<div class="mcycle-promise-desc">从收到商品到质检结束，每个步骤都全程视频监控，检测放心可保障。</div>',"</li>",'<li class="mcycle-promise-model">','<div class="mcycle-promise-icon"><i class="mcycle-font icon-zhijian1"></i></div>','<div class="mcycle-promise-title">专业质检不忽悠</div>','<div class="mcycle-promise-desc">专业的工程师，按统一标准流程检验，拒绝主观评判，各项指标可信赖。</div>',"</li>",'<li class="mcycle-promise-model">','<div class="mcycle-promise-icon"><i class="mcycle-font icon-huishou"></i></div>','<div class="mcycle-promise-title">回收不压价</div>','<div class="mcycle-promise-desc">回收企业直接回收，避免恶意压价。</div>',"</li>","</ul>","</div>"].join("")},getCSRF:function(t){e.ajax({url:"/getcsrf",cache:!1,success:function(s,i,c){var a=c.getResponseHeader("X-CSRF-TOKEN");t&&e.isFunction(t)&&t.call(t,a)}})},templateInit:function(t,s){this.isInitTemplate=!0,this.$bread=e(this.template.model.bread),this.$modelMainFinallyBox=e(this.template.model.modelMainFinallyBox),this.$modelMain=e(a(t,this.template.model.modelMain)).append(this.$modelMainFinallyBox),this.$modelDescription=e(this.template.model.modelDescription),this.$modelContent=e(this.template.model.modelContentBox(this.currentStep)).append(this.template.model.modelImage(t.img),this.$modelMain,this.$modelDescription),this.$model=e(this.template.model.model).append(this.$bread,this.$modelContent),this.$centerMain=e(this.template.centerMain).append(s),this.$mcycleCenter.empty(),this.$mcycleCenter.append(this.$model,this.$centerMain,this.template.promise),this.templateBind()},templateBind:function(){var s=this;this.$bread.on("click","a",function(){var i=e(this).parent().hasClass("reselect-phone");s.setSession({}),i?t.location.href="/repo/index":s.gotoStep(1)})},setSession:function(t){return t=JSON.stringify(t),this.session.setItem(this.sessionName,t),this},getSession:function(){var t=this.session.getItem(this.sessionName);try{return JSON.parse(t)||{}}catch(e){return this.setSession({}),{}}},getParame:function(){var t=window.document.location.href.toString(),e=t.split("?");if(2!=e.length||e[1].length<3)return{};var s=e[1].lastIndexOf("#");e=-1!=s?e[1].substr(0,s):e[1],e=e.split("&");var i,c={};for(var a in e)i=e[a].split("="),c[i[0]]=i[1];return c},gotoLogin:function(){t.location.href="https://login.flyme.cn/sso?appuri=http%3A%2F%2Fstore.meizu.com%2Faccounts%2Flogin.htm&sid=&service=&autodirct=true&useruri="+t.location.href},setFlowStep:function(t){for(var e=this.$mcycleTopbarFlow.children(".mcycle-topbar-flow-box"),s="active",i=1;4>=i;i++)t>=i?e.eq(i).addClass(s):e.eq(i).removeClass(s)},bind:function(){var s=this;e(t).on("popstate",function(){var e=t.history.state;e&&s.checkStep(e.currentStep)})},routerStart:function(t){switch(this.currentStep=t,t){case 1:d.init(global.data),document.title="魅族以旧换新 - 机型评估";break;case 2:r.init(this.sessionData,global.data),document.title="魅族以旧换新 - 提交回收";break;case 3:m.init(this.sessionData.repoId),document.title="魅族以旧换新 - 提交成功"}this.setFlowStep(this.currentStep)},gotoStep:function(s){this.sessionData=this.getSession(),l({currentStep:s}),this.scrollTop(e(t).scrollTop(),this.routerStart.bind(this,s))},scrollTop:function(s,i){var c=this;s>120?setTimeout(function(){s-=20,e(t).scrollTop(s),c.scrollTop(s,i)}):(e(t).scrollTop(120),i&&e.isFunction(i)&&i.call(this))},checkStep:function(t){return!this.sessionData.uid||this.sessionData.uid==this.uid&&this.sessionData.tid==this.tid?1==t?void this.routerStart(1):2==t?void(this.sessionData.cacheSn?this.routerStart(2):(l({currentStep:1},!0),this.routerStart(1))):3==t&&this.sessionData.repoId?void this.routerStart(3):(this.setSession({}),l({currentStep:1},!0),void this.routerStart(1)):(this.setSession({}),l({currentStep:1},!0),void this.routerStart(1))},init:function(t){t.data&&t.data.id&&(this.bind(),this.uid=t.data.uid,this.tid=t.data.id,this.parameData=this.getParame(),this.sessionData=this.getSession(),this.checkStep(this.parameData.currentStep||1))}},d={isInit:!1,template:{description:'<div id="mcycleDescription" class="mcycle-description" />',listBox:'<ul class="mcycle-description-list" />',list:['<li class="mcycle-discription-select close" data-iselects="{{isElects}}">','<div class="mcycle-discription-title">','<div class="mcycle-discription-name">{{name}}</div>','<div class="mcycle-discription-selected-box"><div class="mcycle-discription-selected"></div></div>',"</div>","</li>"].join(""),selectionBox:'<ul class="mcycle-discription-content clearfix" />',selection:['<li class="mcycle-checkbox" data-pid="{{pid}}" data-iselects="{{isElects}}" data-id="{{id}}" data-isprop="{{isProp}}" data-name="{{name}}" data-defaultid="{{defaultId}}">','<div class="mcycle-checkbox-content">','<p class="mcycle-checkbox-title">{{name}}</p>','<p class="mcycle-checkbox-desc">{{remark}}</p>',"</div>","</li>"].join(""),buttonBox:'<div class="mcycle-description-button" />',nextStep:'<button class="mcycle-button disabled">查看估值</button>'},eachList:function(t,s,i,c){var l,n=this;e.each(t,function(){this.isElects=this.isElects?"true":"false",l=e(a(this,n.template.list)),n.eachSelection(this.child,l,i,c),s.append(l)})},eachSelection:function(t,s,i,c){var l=this,n=118*Math.ceil(t.length/5),o=e(this.template.selectionBox).css("height",n);e.each(t,function(){this.isProp=c?"true":"false",this.isElects=this.isElects?"true":"false";var t=e(a(this,l.template.selection)).appendTo(o);if(i&&i[this.id]){var s=e("<ul />");l.eachList(i,s);var n=s.children().addClass("open");t.data("$li",n)}}),o.appendTo(s)},filterTwoList:function(t){var s=[{name:"功能问题（多选或不选）",isElects:!0,child:[]}];return e.each(t,function(){var t=this;e.each(this.child,function(){this.isElects=!0,this.defaultId=t.defaultId}),s[0].child=s[0].child.concat(this.child)}),s},checkOpenBtn:function(t){var e=this.$listBox.children('[data-iselects="false"]').length,s=this.$listBox.children('[data-iselects="false"].success').length;e==s?this.$button.removeClass("disabled"):this.$button.addClass("disabled"),t&&(t.hasClass("checked")?e==s&&this.$button.removeClass("disabled"):this.$button.addClass("disabled"))},bind:function(){var t=this;this.$listBox.on("click",".mcycle-discription-title",function(){var s=e(this).parent(),i="close",c=s.siblings(":not(."+i+")");s.hasClass(i)?s.removeClass(i):(s.addClass(i),c=s),c.addClass(i).removeClass("success error"),c.data("iselects")||c.addClass(c.find(".checked").length?"success":"error"),t.checkOpenBtn()}).on("click",".mcycle-checkbox",function(){var s="checked",i=e(this).data("iselects"),c=e(this).parents(".mcycle-discription-select");if(i){var a=e(this).data("pid");e(this).toggleClass(s).siblings("[data-pid="+a+"]").removeClass(s)}else{var l=e(this).siblings(".checked").removeClass(s);l.data("$li")&&l.data("$li").detach(),e(this).toggleClass(s);var n=e(this).data("$li");n&&(e(this).hasClass(s)?c.after(n):n.detach())}var o=e.map(c.find("."+s),function(t){return e(t).data("name")});c.find(".mcycle-discription-selected").html(o.join("，"));var d="close";!i&&e(this).hasClass(s)?(c.addClass(d+" success").removeClass("error"),c.next().removeClass(d)):i||e(this).hasClass(s)||(c.addClass("error").removeClass(d+" success"),c.next().addClass(d)),!i&&t.checkOpenBtn(e(this))}),this.$buttonBox.on("click","button:not(.disabled)",function(){var s={propertyIds:[],descIds:[]};t.$listBox.find("[data-iselects=false] .mcycle-checkbox.checked").each(function(){var t=e(this).data("id");e(this).data("isprop")?s.propertyIds.push(t):s.descIds.push(t)});var i={};t.$listBox.find("[data-iselects=true] .mcycle-checkbox").each(function(){var t=e(this).data("pid");if(e(this).hasClass("checked")){var s=e(this).data("id");i[t]=s}else if(!i[t]){var c=e(this).data("defaultid");i[t]=c}}),i=e.map(i,function(t){return t}),s.descIds=s.descIds.concat(i),s.propertyIds=s.propertyIds.join(","),s.descIds=s.descIds.join(","),s.gid=o.tid,o.getCSRF(t.handleEvaluation.bind(t,s))})},handleEvaluation:function(s,i){e.ajax({url:"/repo/evaluation",data:JSON.stringify(s),type:"post",headers:{"X-CSRF-TOKEN":i,"Content-Type":"application/json"},beforeSend:c.show.bind(t,o.$centerMain),success:function(t){200==t.code?(t.data.uid=o.uid,t.data.tid=o.tid,o.setSession(t.data),o.gotoStep(2)):401==t.code?o.gotoLogin():o.alert.show(t.msg),c.hide(o.$centerMain)},error:function(){o.alert.show("网络错误"),c.hide(o.$centerMain)}})},initContent:function(t){this.isInit=!0,this.$button=e(this.template.nextStep),this.$buttonBox=e(this.template.buttonBox).append(this.$button),this.$listBox=e(this.template.listBox),t.propList&&this.eachList(t.propList,this.$listBox,null,!0),this.eachList(t.descList.oneList,this.$listBox),this.eachList(t.descList.thrList,this.$listBox,t.childDescMap);var s=this.filterTwoList(t.descList.twoList);return s[0].child.length>0&&this.eachList(s,this.$listBox),this.$listBox.children().eq(0).removeClass("close"),this.$description=e(this.template.description).append(this.$listBox,this.$buttonBox),this.bind(),this.$description},init:function(t){o.isInitTemplate?(this.isInit||(this.isInit=!0,o.$centerMain.append(this.initContent(t))),o.$modelContent.removeClass("finally"),o.$mcycleCenter.removeClass("finally")):(this.isInit=!0,o.templateInit(t,this.initContent(t)))}},r={isInit:!1,data:{isAccept:!1,isexpress:"",contacts:"",phone:"",provice:"",city:"",area:"",street:"",address:""},phoneRule:/^1\d{10}$/,tips:{empty:"必填",phone:"手机号码格式错误",city:"请选择省、市、区、街道",address:"请详细填写地址信息"},setSubmitBtn:function(t){var e="disabled",s=this.$bottom.children(".mcycle-button");return t?(s.removeClass(e),!0):(s.addClass(e),!1)},checkData:function(){return this.data.isAccept?0!==this.data.isexpress&&1!==this.data.isexpress?this.setSubmitBtn():""==this.data.contacts?this.setSubmitBtn():this.phoneRule.test(this.data.phone)?1===this.data.isexpress&&""==this.data.provice?this.setSubmitBtn():1===this.data.isexpress&&""==this.data.city?this.setSubmitBtn():1===this.data.isexpress&&""==this.data.area?this.setSubmitBtn():1===this.data.isexpress&&""==this.data.street?this.setSubmitBtn():1===this.data.isexpress&&this.data.address.length<3?this.setSubmitBtn():this.setSubmitBtn(!0):this.setSubmitBtn():this.setSubmitBtn()},template:{form:'<div class="mcycle-form" />',select:['<div class="mcycle-form-select clearfix">','<div class="mcycle-checkbox">','<div class="mcycle-checkbox-content">','<div class="mcycle-checkbox-title">客服联系上门取件（免邮费）</div>',"</div>",'<div class="mcycle-checkbox-tips">*客服将在您提交后的24小时内与您联系</div>',"</div>",'<div class="mcycle-checkbox">','<div class="mcycle-checkbox-content">','<div class="mcycle-checkbox-title">自行联系快递（免邮费）</div>',"</div>",'<div class="mcycle-checkbox-tips">*优先选择顺丰的货到付款</div>',"</div>","</div>"].join(""),content:['<div class="mcycle-form-content">','<div class="mcycle-form-row clearfix">','<div class="mcycle-form-title">姓名</div>','<input type="text" class="mcycle-form-input" name="contacts" placeholder="长度不超过15个汉字" maxlength="15">','<div class="mcycle-form-tips">必填</div>',"</div>",'<div class="mcycle-form-row clearfix">','<div class="mcycle-form-title">手机号</div>','<input type="text" class="mcycle-form-input" name="phone" placeholder="请输出入11位手机号" maxlength="11">','<div class="mcycle-form-tips"></div>',"</div>","</div>"].join(""),address:['<div class="mcycle-form-content-address">','<div class="mcycle-form-row clearfix">','<div class="mcycle-form-title">我的地址</div>','<div class="mcycle-form-citys"></div>','<div class="mcycle-form-tips"></div>',"</div>",'<div class="mcycle-form-row clearfix">','<div class="mcycle-form-title">详细地址</div>','<input type="text" class="mcycle-form-input long" name="address" placeholder="请输出入3-50个汉字的详细地址，如路名、门牌号" maxlength="50" tabindex="-1">','<div class="mcycle-form-tips"></div>',"</div>","</div>"].join(""),bottom:['<div class="mcycle-form-bottom">','<div class="mcycle-form-protocol">','<div class="mcycle-checkbox-min"></div>','我已查看并接受 <a href="/repo/protocol" target=_blank"" class="mcycle-form-protocol-link">回购协议 ></a>',"</div>",'<button class="mcycle-button disabled">提交</button>',"</div>"].join("")},bind:function(){var t=this,s="checked";this.$select.on("click",".mcycle-checkbox",function(){var i=e(this).index();e(this).toggleClass(s).siblings().removeClass(s),t.$content.removeClass("type1 type2"),e(this).hasClass(s)?0==i?(t.data.isexpress=1,t.$content.addClass("type1")):(t.data.isexpress=0,t.$content.addClass("type2")):t.data.isexpress="",t.checkData()}),this.$bottom.on("click",".mcycle-checkbox-min",function(){e(this).toggleClass(s),t.data.isAccept=e(this).hasClass(s)?!0:!1,t.checkData()}),this.citys.on("change",function(){t.data.provice=this.data.provice.text,t.data.city=this.data.city.text,t.data.area=this.data.area.text,t.data.street=this.data.street.text;var e=t.$address.children(":eq(0)"),s=e.find(".mcycle-form-tips"),i="error";""==t.data.provice||""==t.data.city||""==t.data.area||""==t.data.street?(s.text(t.tips.city),e.addClass(i)):(s.empty(),e.removeClass(i)),t.checkData()}),this.$content.find(".mcycle-form-input").on("input propertychange",function(){var s=e(this).attr("name"),i=e(this).val();t.data[s]=i,t.checkData()}),this.$content.on("blur",".mcycle-form-input",function(){var s=e(this).attr("name"),i=e(this).val(),c=e(this).parents(".mcycle-form-row"),a=c.find(".mcycle-form-tips"),l="error";switch(s){case"contacts":""==e.trim(i)?(a.text(t.tips.empty),c.addClass(l)):(a.empty(),c.removeClass(l));break;case"phone":""==e.trim(i)?(a.text(t.tips.empty),c.addClass(l)):t.phoneRule.test(i)?(a.empty(),c.removeClass(l)):(a.text(t.tips.phone),c.addClass(l));break;case"address":e.trim(i).length<3?(a.text(t.tips.address),c.addClass(l)):(a.empty(),c.removeClass(l))}}),this.$bottom.on("click",".mcycle-button:not(.disabled)",function(){var s=e.map(o.sessionData.strList,function(t){return t.val}),i={tid:o.sessionData.tid,goodsName:o.sessionData.goodsName,cacheSN:o.sessionData.cacheSn,details:s.join("|"),appraisal:o.sessionData.appraisal,aThrSubsidy:o.sessionData.aThrSubsidy,isexpress:t.data.isexpress,address:0==t.data.isexpress?"":t.data.provice+t.data.city+t.data.area+t.data.street+t.data.address,phone:t.data.phone,contacts:t.data.contacts};o.getCSRF(t.handleAcceptOffer.bind(t,i))})},handleAcceptOffer:function(s,i){e.ajax({url:"/repo/acceptOffer",type:"post",headers:{"X-CSRF-TOKEN":i,"Content-Type":"application/json"},data:JSON.stringify(s),beforeSend:c.show.bind(t,o.$centerMain),success:function(t){200==t.code?(o.setSession({tid:o.tid,uid:o.uid,repoId:t.data}),o.gotoStep(3)):401==t.code?o.gotoLogin():o.alert.show(t.msg),c.hide(o.$centerMain)},error:function(){o.alert.show("网络错误"),c.hide(o.$centerMain)}})},initContent:function(){var t=this;return this.isInit=!0,this.$form=e(this.template.form),this.$select=e(this.template.select),this.$content=e(this.template.content),this.$address=e(this.template.address).appendTo(this.$content),this.citys=new s({selector:t.$address.find(".mcycle-form-citys")}),this.$bottom=e(this.template.bottom),this.$form.append(this.$select,this.$content,this.$bottom),this.bind(),this.$form},init:function(t,s){o.isInitTemplate&&!this.isInit?o.$centerMain.append(this.initContent()):o.isInitTemplate||this.isInit||o.templateInit(s,this.initContent()),o.$modelMainFinallyBox.html(a(t,o.template.model.modelMainFinally)),o.$modelDescription.empty(),e.each(t.strList,function(){o.$modelDescription.append(o.template.model.modelDescriptionDetail(this.val))}),o.$modelDescription.css("height",t.strList.length>18?24*Math.ceil(t.strList.length/2):210),o.$modelContent.addClass("finally"),o.$mcycleCenter.addClass("finally")}},m={template:{success:['<div class="mcycle-success">','<ul class="mcycle-bread clearfix" id="mcycleBread">','<li class="mcycle-bread-box"><a href="javascript:;">返回首页</a></li>',"</ul>",'<div class="mcycle-success-content">','<i class="mcycle-font icon-right"></i>','<div class="mcycle-success-text">','<div class="mcycle-success-title">回购单提交成功！</div>','<div class="mcycle-success-desc">寄出物品后，请填写物流单号。<a href="http://store.meizu.com/member/repurchase_receipt/detail/{{orderNo}}" class="mcycle-success-link">查看回购单详情></a></div>',"</div>","</div>","</div>"].join(""),tips:['<div class="mcycle-tips clearfix">','<div class="mcycle-tips-title">温馨提示：</div>','<ul class="mcycle-tips-list">','<li class="mcycle-tips-content">','<i class="mcycle-font icon-jiesuomima"></i>','<div class="mcycle-tips-content-text">','<div class="mcycle-tips-content-title">取消密码</div>','<div class="mcycle-tips-content-desc">',"<p>请将设置的密码取消,</p>","<p>以便我们检测人员及时进行功能检测。</p>","</div>","</div>","</li>",'<li class="mcycle-tips-content">','<i class="mcycle-font icon-tuichu"></i>','<div class="mcycle-tips-content-text">','<div class="mcycle-tips-content-title">退出账号</div>','<div class="mcycle-tips-content-desc">',"<p>苹果手机IOS7 以上请退出iCloud账号,</p>","<p>魅族请退出Flyme 账号。</p>","</div>","</div>","</li>","</ul>","</div>"].join("")},bind:function(){this.$success.on("click",".mcycle-bread a",function(){o.setSession({}),t.location.href="/repo/index"})},init:function(t){this.$success=e(a({orderNo:t},this.template.success)),this.bind(),o.$mcycleCenter.empty(),o.$mcycleCenter.append(this.$success,this.template.tips)}};n.init(),o.init(t.global)}(window,require("common:lib/jquery/jquery-1.11.3"),require("mcycle:lib/citys/citys"),require("mcycle:lib/dialog/dialog"),require("mcycle:lib/loading/loading"),require("mcycle:lib/helper/modalApplier"),require("mcycle:lib/helper/pushUrl"),require("mcycle:widgets/search/search"));